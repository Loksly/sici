



<div class="row" ng-if="!procedimientoSeleccionado.eliminado">
    <div class="col-lg-12">
        <div class="btn btn-default pull-right" ng-click="$root.exportDOC('detalles', 'Procedimiento_' + procedimientoSeleccionado.codigo)">
            <span class="glyphicon glyphicon-book"></span>
        </div>
        <div ng-if="procedimientoSeleccionado" class="details" id="detalles" >
            <hr/>
            <h4 class="text-danger">{{procedimientoSeleccionado.denominacion}}</h4>
            <ol class="breadcrumb" id="breadcrumb">
                <li ng-repeat="ancestro in procedimientoSeleccionado.ancestros|reverse ">
                    <a href="/actividad/{{ancestro.id}}">{{ancestro.nombrelargo}}</a>
                </li>
                <li class="active">{{procedimientoSeleccionado.denominacion}}</li>
                <li class="active" >{{anualidad.substring(1, 5)}} 
                    <a ng-if="$root.permisoscalculados.superuser" href="" ng-click="setShowArbol()">&nbsp;
                        <span  class="glyphicon glyphicon-pencil"></span>
                    </a>
                </li>
            </ol>
            <!--- ARBOL PARA CAMBIO EN JERARQUÍA -->
            <div  ng-if="$root.permisoscalculados.superuser" ng-class="{'hidden':!isShowArbol()}" class="animated">
                <div class="panel panel-danger">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            Organismos
                        </h3>
                    </div>
                    <div class="panel-body">			
                        <input type="text" ng-model="texto.$" placeholder="Filtro" style="margin-bottom:1em" class="form-control"/>
                        <ul ng-if="arbol.length" style="padding-left:0.6em">
                            <li ng-repeat="element in arbol|filter:texto| filter:filtrojerarquia" ng-class="{'list-group-item-warning':element.id == seleccionado.id}">
                                <p>
                                    <strong>
                                        [{{element.id}}] &nbsp;
                                    </strong>
                                    <span ng-click="setSeleccionado(element)" class="cursor"  title="Engloba {{element.numprocedimientos}} procedimientos" scroll-to-item scroll-to="#changeorcancel">
                                        {{element.title}} 
                                    </span>

                                </p>
                                <ul class="list-group" ng-if="element.nodes" style="clear:both">
                                    <li class="list-group-item" ng-repeat="elemen in element.nodes|filter:texto | filter:filtrojerarquia" ng-class="{'list-group-item-danger':elemen.id == seleccionado.id}">
                                        <p>
                                            <strong>
                                                [{{elemen.id}}] &nbsp;
                                            </strong>
                                            <span ng-click="setSeleccionado(elemen)" class="cursor" title="Engloba {{elemen.numprocedimientos}} procedimientos" scroll-to-item scroll-to="#changeorcancel">
                                                {{elemen.title}} 
                                            </span>

                                        </p>
                                        <ul ng-if="elemen.nodes" style="clear:both">
                                            <li ng-repeat="eleme in elemen.nodes|filter:texto |filter:filtrojerarquia"  ng-class="{'list-group-item-danger':eleme.id == seleccionado.id}" >
                                                <p>
                                                    <strong>
                                                        [{{eleme.id}}] &nbsp;
                                                    </strong>
                                                    <span ng-class="{'bg-danger':eleme.id == seleccionado.id }" ng-click="setSeleccionado(eleme)" class="cursor" title="Engloba {{eleme.numprocedimientos}} procedimientos" scroll-to-item scroll-to="#changeorcancel">
                                                        {{eleme.title}} 
                                                    </span>

                                                </p>
                                                <ul ng-if="eleme.nodes" style="clear:both">
                                                    <li ng-repeat="elem in eleme.nodes|filter:texto |filter:filtrojerarquia">
                                                        <p>
                                                            <strong>
                                                                [{{elem.id}}] &nbsp;
                                                            </strong>
                                                            <span ng-class="{'bg-danger':elem.id == seleccionado.id }" ng-click="setSeleccionado(elem)" class="cursor"  title="Engloba {{elem.numprocedimientos}} procedimientos" scroll-to-item scroll-to="#changeorcancel">
                                                                {{elem.title}} 
                                                            </span>

                                                        </p>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                        <div id="changeorcancel">
                            <button type="button" class="btn btn-default" ng-click="changeOrganica()" ng-class="{'disabled': seleccionado == null}">
                                <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> Asignar a la estructura
                            </button>&nbsp;&nbsp;
                            <button type="button" class="btn btn-default" ng-click="cancelChangeOrganica()">
                                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Cancelar
                            </button>			
                            <br/>
                            <small><span ng-bind="mensajeMoviendo" class=""></span></small>
                        </div>						
                    </div>
                </div>

            </div>
            <!-- FIN ARBOL PARA CAMBIO DE JERARQUÍA -->


            <nav>
                <ul class="pager" ng-if="procedimientoSeleccionado.periodos[anualidad]" >	
                    <li ng-if="!!procedimientoSeleccionado.periodos['a' + getPrev()]" class="previous" ><a ng-click="prevYear()" href="" ><span aria-hidden="true">&larr;</span> {{getPrev()}}</a></li>
                    <li ng-if="!!procedimientoSeleccionado.periodos['a' + getNext()]" class="next" ><a ng-click="nextYear()" href="" >{{getNext()}} <span aria-hidden="true">&rarr;</span></a></li>
                </ul>
            </nav>
            <!--[if lt IE 9]>
            <p style="margin-top:1em;">
                    <div class="alert alert-warning" role="alert">Esta usted utilizando una versión de Internet Explorer obsoleta con la que podrá introducir datos pero que no permite ciertas funcionalidades de la aplicación. 
Actualice el navegador a la versión más reciente o instale <a target="_blank" href="https://www.google.es/chrome/browser/index.html">Chrome</a> o <a target="_blank" href="http://getfirefox.com/">Firefox</a>.</div>
            </p>
            <![endif]-->
            <div class="col-lg-6">
                <ul>
                    <li ng-repeat="attr in attrspar" >
                        <strong>{{attr| translate}}</strong>
                        <span>&nbsp;</span>
                        <a ng-if="$root.permisoscalculados.superuser" href="#" onaftersave="recalculate(true)" editable-text="procedimientoSeleccionado[attr]">{{(procedimientoSeleccionado[attr]!=null && procedimientoSeleccionado[attr] != '') ?procedimientoSeleccionado[attr] : '-' }}</a>
                        <span ng-if="!$root.permisoscalculados.superuser" >{{ procedimientoSeleccionado[attr]!=null ?procedimientoSeleccionado[attr]  : '-' }}</span>
                    </li>
                    <li ng-repeat="(index,attr) in attrsanualidad" ng-show="exists(attr)">
                        <div >
                            <strong>{{attr| translate}}</strong>
                            <span>&nbsp;</span>
                            <a  title="edita este valor"  href="#" ng-if="(W  && attrsanualidad_permisos[index] != 's' && (attr!='pendientes_iniciales' || getIntAnualidad()==2014)) || $root.permisoscalculados.superuser" onaftersave="recalculate(true)"  editable-text="procedimientoSeleccionado.periodos[anualidad][attr]">{{ procedimientoSeleccionado.periodos[anualidad][attr]!=null ? procedimientoSeleccionado.periodos[anualidad][attr] :  '-' }}</a>
                            <span ng-if="!((W && attrsanualidad_permisos[index] != 's' && (attr!='pendientes_iniciales' || getIntAnualidad()==2014) ) || $root.permisoscalculados.superuser)" >{{ (procedimientoSeleccionado.periodos[anualidad][attr]!=null && procedimientoSeleccionado.periodos[anualidad][attr]!='') ? procedimientoSeleccionado.periodos[anualidad][attr] : '-' }}</span>
                        </div>
                    </li>
                    <li>
                        <strong>Padre:</strong>
                        <span>&nbsp;</span>
                        <div ng-if="!mostrarAutocompletePadre">{{nombrePadre}}
                            <a style="text-decoration: none;" ng-if="$root.permisoscalculados.superuser" href="" ng-click="editarPadre()">&nbsp;
                                <span  class="glyphicon glyphicon-pencil"></span> 
                            </a>
                            <a style="text-decoration: none;" ng-if="$root.permisoscalculados.superuser && procedimientoSeleccionado.padre" href="" ng-click="deletePadre()">&nbsp;
                                <span class="glyphicon glyphicon-trash"></span> 
                            </a>
                        </div>
                        <div ng-if="mostrarAutocompletePadre">
                            <input  placeholder="Introduce cualquier parte del c&oacute;digo o denominaci&oacute;n" class="col-lg-9 col-xs-12" type="text" ng-model="padre" typeahead-on-select="updatePadre($item)" name="padre" typeahead="showProcedimiento(procpadre) for procpadre in procedimientosPadre | codigoDenominacion:$viewValue | limitTo:10" typeahead-editable="false" />
                            <a style="text-decoration: none;" ng-if="$root.permisoscalculados.superuser" href="" ng-click="ocultarEditarPadre()">&nbsp;
                                <span class="glyphicon glyphicon-remove"></span> 
                            </a>
                        </div>
                    </li>
                </ul>
				<p ng-if="W && !periodosOk(anualidad, procedimientoSeleccionado)"><br/><span class="alert alert-danger" role="alert">Debe definir el plazo en alguno de las modalidades para poder introducir datos.</span></p>
                <br />
                <div ng-if="$root.permisoscalculados.superuser">
                    <div>
                        <button type="button" ng-if="!procedimientoSeleccionado.oculto" class="btn btn-warning" aria-label="Left Align" ng-click="ocultarProcedimiento(procedimientoSeleccionado)">
                            <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span> &nbsp;Ocultar
                        </button>
                        <button type="button" ng-if="procedimientoSeleccionado.oculto" class="btn btn-default" aria-label="Left Align" ng-click="ocultarProcedimiento(procedimientoSeleccionado)">
                            <span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> &nbsp;Anular Oculto
                        </button>
                        <button type="button" ng-if="!procedimientoSeleccionado.eliminado" class="btn btn-danger" aria-label="Left Align" ng-disabled="tieneHijos > 0 || procedimientoSeleccionado.oculto"  ng-click="resetData()">
                            <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> &nbsp;Resetear procedimiento
                        </button>
                        <button type="button" ng-if="!procedimientoSeleccionado.eliminado" class="btn btn-danger" aria-label="Left Align" ng-disabled="tieneHijos > 0 || procedimientoSeleccionado.oculto"  ng-click="eliminarProcedimiento(procedimientoSeleccionado)">
                            <span class="glyphicon glyphicon-trash" aria-hidden="true"></span> &nbsp;Eliminar procedimiento
                        </button>
                        <button type="button" class="btn btn-default" aria-label="Left Align" ng-click="descargarExcel()">
                            <span class="glyphicon glyphicon-stats" aria-hidden="true"></span>&nbsp;Descargar excel
                        </button>
                        <span ng-if="tieneHijos > 0 && !procedimientoSeleccionado.oculto"><br/>
                            No puede eliminar el procedimiento porque tiene hijos. Elimine los hijos antes de eliminar este procedimiento.
                        </span>
                        <div ng-if="respuesta" class="alert {{respuesta.clase}}" role="alert">{{respuesta.mensaje}}</div>
                    </div>
                    <br/>
                </div>
                <div class="panel panel-danger">
                    <div class="panel-heading">
                        <h3 class="panel-title">Responsables</h3>
                    </div>
                    <div class="panel-body">
                        <ul ng-repeat="responsable in procedimientoSeleccionado.responsables">
                            <li ng-repeat="attr in attrsresp">
                                <strong>{{attr| translate}}</strong>
                                <span>&nbsp; {{ responsable[attr] || '-' }}</span>
                            </li>
                        </ul>
                        <p ng-If="(!procedimientoSeleccionado.responsables || procedimientoSeleccionado.responsables.length==0) && procedimientoSeleccionado.cod_plaza">
                            No hay ninguna persona asociada al código de plaza {{procedimientoSeleccionado.cod_plaza}}.
                        </p>
                        <p ng-If="(!procedimientoSeleccionado.responsables || procedimientoSeleccionado.responsables.length==0) && !procedimientoSeleccionado.cod_plaza">
                            Debe establecer el código de plaza del responsable de este procedimiento.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="panel panel-danger">
                    <div class="panel-heading">
                        <h3 class="panel-title">Detalles según la guía</h3>
                    </div>
                    <div class="panel-body">
                        <div class="btn-group pull-right">
                            <div ng-click="detallesCarmHTML = true" ng-class="{'btn-danger':detallesCarmHTML,'btn-default':!detallesCarmHTML}" class="btn btn-default">
                                <span class="glyphicon glyphicon-list"></span>
                            </div>
                            <div ng-click="detallesCarmHTML = false" ng-class="{'btn-danger':!detallesCarmHTML,'btn-default':detallesCarmHTML}" class="btn">
                                <span class="glyphicon glyphicon-align-left"></span>
                            </div>
                            <a target="_blank" href="https://www.carm.es/web/pagina?IDTIPO=240&amp;IDCONTENIDO={{procedimientoSeleccionado.codigo}}" class="btn btn-default"> 
                                <span class="glyphicon glyphicon-info-sign"></span>
                            </a>
                        </div>
                        <div class="procedimiento">
                            <div ng-repeat="(key,val) in detallesCarm" style="clear:both" ng-bind-html="val | treatAsHTML" ng-class="{ 'hidden':!detallesCarmHTML }">
                            </div>
                            <div ng-repeat="(key,val) in detallesCarm2" style="clear:both" ng-class="{ 'hidden':detallesCarmHTML }">
                                <strong>{{key}}</strong>
                                <span>&nbsp;</span>
                                <span>{{val}}</span>
                            </div>
                            <div class="clear"></div>
                        </div>	
                    </div>
                </div>
            </div>
            <div style="clear:both" class="table-responsive">
                <nav>
                    <ul class="pager" ng-if="procedimientoSeleccionado.periodos[anualidad]">	
                        <li ng-if="!!procedimientoSeleccionado.periodos['a' + getPrev()]" class="previous" ><a ng-click="prevYear()" href="" ><span aria-hidden="true">&larr;</span> {{getPrev()}}</a></li>
                        <li ng-if="!!procedimientoSeleccionado.periodos['a' + getNext()]" class="next" ><a ng-click="nextYear()" href="" >{{getNext()}} <span aria-hidden="true">&rarr;</span></a></li>
                    </ul>
                </nav>
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th></th>
                            <th ng-repeat="mes in meses">{{mes}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="attr in attrstabla" ng-show="exists(attr)"> 
                            <th>{{attr| translate}}</th>
                            <td ng-repeat="val in procedimientoSeleccionado.periodos[anualidad][attr] track by $index" class="numberCell">
                                <a e-ng-blur="changeFocus($form, $index, attr, $data)" ng-if="W && procedimientoSeleccionado.periodos[anualidad].periodoscerrados[$index] == 0 && periodosOk(anualidad, procedimientoSeleccionado)" href="#" editable-text="procedimientoSeleccionado.periodos[anualidad][attr][$index]" onaftersave="recalculate()" onbeforesave="checkNumber($data, anualidad, attr, $index)">
                                    {{ procedimientoSeleccionado.periodos[anualidad][attr][$index] || 0  |numberFormat}} {{addForm(attr, $index, $form)}}
                                </a>
                                <span ng-if="!W || procedimientoSeleccionado.periodos[anualidad].periodoscerrados[$index] != 0 || !periodosOk(anualidad, procedimientoSeleccionado)">{{ procedimientoSeleccionado.periodos[anualidad][attr][$index] || 0  |numberFormat}}</span>
                            </td>
                        </tr>
                        <tr ng-repeat="attr in attrstablacalculados" ng-show="exists(attr)"> 
                            <th>{{attr| translate}}</th>							
                            <td ng-repeat="val in procedimientoSeleccionado.periodos[anualidad][attr] track by $index" ng-class="{'text-danger': val &lt; 0 }" class="numberCell">
                                <span ng-if="anualidad != 'a2013' || (!W && !$root.permisoscalculados.superuser) || procedimientoSeleccionado.periodos[anualidad].periodoscerrados[$index]">
                                    {{val| numberFormat}} 
                                </span>								
                                <span ng-if="anualidad == 'a2013' && (W || $root.permisoscalculados.superuser) && !procedimientoSeleccionado.periodos[anualidad].periodoscerrados[$index]" editable-text="procedimientoSeleccionado.periodos[anualidad][attr][$index]" onaftersave="recalculate()" onbeforesave="checkNumber($data, anualidad, attr, $index)">
                                    {{val| numberFormat}}
                                </span>								
                            </td>

                        </tr>
                    </tbody>
                    <tfooter>
                        <tr>
                            <th></th>
                            <th ng-repeat="mes in meses">{{mes}}</th>
                        </tr>
                    </tfooter>
                </table>
                <p>Para editar un valor de la tabla, pulse sobre la casilla correspondiente. Si desea editar en serie, pulse la tecla 'tabulador' para pasar a la siguiente casilla.</p>
                <p>Hay campos que se calculan a partir de los datos introducidos en el resto. Las fórmulas usadas son:
                </p>
                <ul>
                    <li>
                        <strong>{{"total_resueltos"|translate}}</strong> =
                        <em>{{"resueltos_1"|translate}}</em> + <em>{{"resueltos_5"|translate}}</em> + 
                        <em>{{"resueltos_10"|translate}}</em> + <em>{{"resueltos_15"|translate}}</em> + 
                        <em>{{"resueltos_30"|translate}}</em> + <em>{{"resueltos_45"|translate}}</em> + 
                        <em>{{"resueltos_mas_45"|translate}}</em> + <em>{{"resueltos_desistimiento_renuncia_caducidad"|translate}}</em> + 
                        <em>{{"resueltos_prescripcion"|translate}}</em> 
                    </li>
                    <li>
                        <strong>{{"fuera_plazo"|translate}}</strong> =
                        <em>{{"total_resueltos"|translate}}</em> - <em>{{"en_plazo"|translate}}</em>  
                    </li>
                    <li>
                        <strong>{{"pendientes"|translate}}</strong> =
                        <em>Pendientes del mes previo</em> + <em>{{'solicitados'|translate}}</em> - <em>{{'total_resueltos'|translate}}</em>
                    </li>
                </ul>
            </div>
            <div ng-if="graphs[0].data" class="row">
                <div class="col-md-12">
                    <div class="btn-group pull-right">
                        <div ng-click="graficasgrandes = !graficasgrandes; updateGraphKeys(anualidad.substring(1,5))" class="btn btn-default">
                            <span ng-class="{'glyphicon-resize-full':!graficasgrandes,'glyphicon-resize-small':graficasgrandes}" class="glyphicon"></span>
                        </div>
                        <div ng-click="graficasbarras = !graficasbarras; updateGraphKeys(anualidad.substring(1,5));" ng-class="{active:graficasbarras, 'btn-default':!graficabarras}" class="btn">
                            <span class="glyphicon glyphicon-stats"></span>
                        </div>
                    </div>
                </div>

                <hr style="clear:both"/>
                <div ng-repeat="graph in graphs" ng-if="graph.data" ng-show="!graficasbarras && graph.data && !graficasgrandes" ng-class="{'col-lg-3':(numgraphs % 4 == 0),'col-lg-3':(numgraphs % 3 == 0)}" class="col-md-12 well">
                    <h5 class="text-danger text-center">{{graph.caption}}</h5>
                    <nvd3-line-chart noData="No hay datos que mostrar" data="graph.data" showXAxis="true" showYAxis="true" showLegend="true" interactive="true" height="350" xAxisTickValues="xAxisTickValuesFunction()" xAxisTickFormat="xAxisTickFormatFunction()" rotateLabels="45" forcey="graph.forcey">
                        <svg></svg>
                    </nvd3-line-chart>
                </div>
                <div ng-repeat="graph in graphs" ng-if="graph.data" ng-show="graficasbarras && graph.data && !graficasgrandes" ng-class="{'col-lg-3':(numgraphs % 4 == 0),'col-lg-3':(numgraphs % 3 == 0)}" class="col-md-12 well">
                    <h5 class="text-danger text-center">{{graph.caption}}</h5>
                    <nvd3-multi-bar-chart noData="No hay datos que mostrar" data="graph.data" showXAxis="true" showYAxis="true" showLegend="true" interactive="true" height="350" xAxisTickValues="xAxisTickValuesFunction()" xAxisTickFormat="xAxisTickFormatFunction()" rotateLabels="45" forcey="graph.forcey" >
                        <svg></svg>
                    </nvd3-multi-bar-chart>
                </div>				
                <div ng-repeat="graph in graphs" ng-if="graph.data" ng-show="!graficasbarras && graph.data && graficasgrandes" style="clear:both" class="col-lg-12 well">
                    <h5 class="text-danger text-center">{{graph.caption}}</h5>
                    <nvd3-line-chart previous="nvd3-multi-bar-chart" noData="No hay datos que mostrar" data="graph.data" showXAxis="true" showYAxis="true" showLegend="true" interactive="true" height="350" xAxisTickValues="xAxisTickValuesFunction()" xAxisTickFormat="xAxisTickFormatFunction()" rotateLabels="45" forcey="graph.forcey">
                        <svg>
                        </svg>
                    </nvd3-line-chart>
                </div>
                <div ng-repeat="graph in graphs" ng-if="graph.data" ng-show="graficasbarras && graph.data && graficasgrandes" style="clear:both" class="col-lg-12 well">
                    <h5 class="text-danger text-center">{{graph.caption}}</h5>
                    <nvd3-multi-bar-chart previous="nvd3-multi-bar-chart" noData="No hay datos que mostrar" data="graph.data" showXAxis="true" showYAxis="true" showLegend="true" interactive="true" height="350" xAxisTickValues="xAxisTickValuesFunction()" xAxisTickFormat="xAxisTickFormatFunction()" rotateLabels="45" forcey="graph.forcey">
                        <svg>
                        </svg>
                    </nvd3-multi-bar-chart>
                </div>
            </div>
            <hr/>
            <h5 class="text-danger" ng-If="procedimientoSeleccionado.periodos[anualidad].Incidencias">Incidencias</h5>
            <div class="table-resposive" ng-If="procedimientoSeleccionado.periodos[anualidad].Incidencias">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th></th>
                            <th ng-repeat="mes in meses">{{mes}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="(incidencia,valores) in procedimientoSeleccionado.periodos[anualidad].Incidencias"> 
                            <th>{{incidencia}}</th>
                            <td ng-repeat="val in valores track by $index" ng-class="{'text-danger': val }" class="numberCell">{{val}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <hr  ng-If="procedimientoSeleccionado.periodos[anualidad].Incidencias"/>
            <h5 class="text-danger" ng-If="inconsistencias.length>0">Inconsistencias</h5>
            <p ng-If="inconsistencias.length>0">Una inconsistencia se da cuando alguno de los datos introducidos no refleja valores coherentes con el resto. Así, por ejemplo, no es consistente que haya un número negativo de expedientes resueltos, ni que el número de expedientes resueltos sea superior al de expedientes solicitados.</p>
            <div ng-repeat="inconsistencia in inconsistencias" role="alert" ng-if="inconsistencia.datos.length > 0" class="alert alert-warning">
                <span>{{inconsistencia.titulo}}</span>
            </div>

        </div>
    </div>
</div>
<div class="row" ng-if="procedimientoSeleccionado.eliminado">
    <div class="jumbotron">
        <h3 style="text-align: center;">El procedimiento ha sido eliminado</h3>
    </div>
</div>
<hr class="clear"/>