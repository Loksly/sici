
<div class="row">
	<div class="col-lg-12">
		<div ng-if="procedimientoSeleccionado" class="details">
			<hr/>
			<h4 class="text-danger">{{procedimientoSeleccionado.denominacion}}</h4>
			<ol class="breadcrumb">
				<li ng-repeat="ancestro in procedimientoSeleccionado.ancestros |reverse">
					<a href="/actividad/{{ancestro.id}}">{{ancestro.nombrelargo}}</a>
				</li>
				<li class="active">{{procedimientoSeleccionado.denominacion}}</li>
				<li class="active">{{anualidad}}</li>
			</ol>
			<div class="col-lg-6">
				<ul>
					<li ng-repeat="attr in attrspar">
						<strong>{{attr| translate}}</strong>
						<span>&nbsp;</span>
						<a href="#" onaftersave="recalculate()" editable-text="procedimientoSeleccionado[attr]">{{ procedimientoSeleccionado[attr] || '-' }}</a>
					</li>
					<li ng-repeat="attr in attrsanualidad">
						<strong>| {{attr| translate}}</strong>
						<span>&nbsp;</span>
						<a href="#" onaftersave="recalculate()" editable-text="procedimientoSeleccionado.anualidades[anualidad][attr]">{{ procedimientoSeleccionado.anualidades[anualidad][attr] || '-' }}</a>
					</li>
				</ul>
				<div class="panel panel-danger">
					<div class="panel-heading">
						<h3 class="panel-title">Responsables</h3>
					</div>
					<div class="panel-body">
						<ul ng-repeat="responsable in procedimientoSeleccionado.responsables">
							<li ng-repeat="attr in attrsresp">
								<strong>{{attr| translate}}</strong>
								<span>&nbsp; {{ responsable[attr] || '-' }}</span>
							</li>
						</ul>
						<p ng-If="(!procedimientoSeleccionado.responsables || procedimientoSeleccionado.responsables.length==0) && procedimientoSeleccionado.cod_plaza">
						No hay ninguna persona asociada al código de plaza {{procedimientoSeleccionado.cod_plaza}}.
						</p>
						<p ng-If="(!procedimientoSeleccionado.responsables || procedimientoSeleccionado.responsables.length==0) && !procedimientoSeleccionado.cod_plaza">
						Debe establecer el código de plaza del responsable de este procedimiento.
						</p>
					</div>
				</div>
			</div>
			<div class="col-lg-6">
				<div class="panel panel-danger">
					<div class="panel-heading">
						<h3 class="panel-title">Detalles según la guía</h3>
					</div>
					<div class="panel-body">
						<div class="btn-group pull-right">
							<div ng-click="detallesCarmHTML=true" ng-class="{'btn-danger':detallesCarmHTML,'btn-default':!detallesCarmHTML}" class="btn btn-default">
								<span class="glyphicon glyphicon-list"></span>
							</div>
							<div ng-click="detallesCarmHTML=false" ng-class="{'btn-danger':!detallesCarmHTML,'btn-default':detallesCarmHTML}" class="btn">
								<span class="glyphicon glyphicon-align-left"></span>
							</div>
							<a target="_blank" href="https://www.carm.es/web/pagina?IDTIPO=240&amp;IDCONTENIDO={{procedimientoSeleccionado.codigo}}" class="btn btn-default"> 
								<span class="glyphicon glyphicon-info-sign"></span>
							</a>
						</div>
						<div class="procedimiento">
							<div ng-repeat="(key,val) in detallesCarm" style="clear:both" ng-bind-html="val |treatAsHTML" ng-class="{ 'hidden':!detallesCarmHTML }">
							</div>
							<div ng-repeat="(key,val) in detallesCarm2" style="clear:both" ng-class="{ 'hidden':detallesCarmHTML }">
								<strong>{{key }}</strong>
								<span>&nbsp;</span>
								<span>{{val}}</span>
							</div>
							<div class="clear"></div>
						</div>	
					</div>
				</div>
			</div>
			<div style="clear:both" class="table-responsive">
				<table class="table table-striped table-bordered">
					<thead>
						<tr>
							<th></th>
							<th ng-repeat="mes in meses">{{mes}}</th>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="attr in attrstabla"> 
							<th>{{attr | translate}}</th>
							<td ng-repeat="val in procedimientoSeleccionado.periodos[anualidad][attr] track by $index" class="numberCell">
								<a href="#" editable-text="procedimientoSeleccionado.periodos[anualidad][attr][$index]" onaftersave="recalculate()" onbeforesave="checkNumber($data)">
									{{ procedimientoSeleccionado.periodos[anualidad][attr][$index] || 0  |numberFormat}}
								</a>
							</td>
						</tr>
						<tr ng-repeat="attr in attrstablacalculados"> 
							<th>{{attr | translate}}</th>
							<td ng-repeat="val in procedimientoSeleccionado.periodos[anualidad][attr] track by $index" ng-class="{'text-danger': val&lt;0 }" class="numberCell">{{val | numberFormat}}</td>
						</tr>
					</tbody>
				</table>
				<p>Hay campos que se calculan a partir de los datos introducidos en el resto. Las fórmulas usadas son:
				</p>
				<ul>
					<li>
						<strong>{{"total_resueltos" |translate}}</strong> =
						<em>{{"resueltos_1" |translate}}</em> + <em>{{"resueltos_5" |translate}}</em> + 
						<em>{{"resueltos_10" |translate}}</em> + <em>{{"resueltos_15" |translate}}</em> + 
						<em>{{"resueltos_30" |translate}}</em> + <em>{{"resueltos_45" |translate}}</em> + 
						<em>{{"resueltos_mas_45" |translate}}</em> + <em>{{"resueltos_desistimiento_renuncia_caducidad" |translate}}</em> + 
						<em>{{"resueltos_mas_45" |translate}}</em> + <em>{{"resueltos_prescripcion" |translate}}</em> 
					</li>
					<li>
						<strong>{{"fuera_plazo"|translate}}</strong> =
						<em>{{"total_resueltos" |translate}}</em> - <em>{{"en_plazo" |translate}}</em>  
					</li>
					<li>
						<strong>{{"pendientes"|translate}}</strong> =
						<em>Pendientes del mes previo</em> + <em>{{'solicitados'|translate}}</em> - <em>{{'total_resueltos'|translate}}</em>
					</li>
				</ul>
			</div>
			<div ng-if="graphs[0].data" class="row">
				<div class="col-md-12">
					<div class="btn-group pull-right">
						<div ng-click="graficasgrandes=!graficasgrandes" class="btn btn-default">
							<span ng-class="{'glyphicon-resize-full':!graficasgrandes,'glyphicon-resize-small':graficasgrandes}" class="glyphicon"></span>
						</div>
						<div ng-click="graficasbarras=!graficasbarras" ng-class="{active:graficasbarras, 'btn-default':!graficabarras}" class="btn">
							<span class="glyphicon glyphicon-stats"></span>
						</div>
					</div>
				</div>
				
				<hr style="clear:both"/>
				<div ng-repeat="graph in graphs" ng-if="!graficasbarras &amp;&amp; graph.data &amp;&amp; !graficasgrandes" ng-class="{'col-lg-3':(numgraphs%4==0),'col-lg-3':(numgraphs%3==0)}" class="col-md-12 well">
					<h5 class="text-danger text-center">{{graph.caption}}</h5>
					<nvd3-line-chart noData="No hay datos que mostrar" data="graph.data" showXAxis="true" showYAxis="true" showLegend="true" interactive="true" height="350" xAxisTickValues="xAxisTickValuesFunction()" xAxisTickFormat="xAxisTickFormatFunction()" rotateLabels="45" forcey="graph.forcey">
						<svg></svg>
					</nvd3-line-chart>
				</div>
				<div ng-repeat="graph in graphs" ng-if="graficasbarras &amp;&amp; graph.data &amp;&amp; !graficasgrandes" ng-class="{'col-lg-3':(numgraphs%4==0),'col-lg-3':(numgraphs%3==0)}" class="col-md-12 well">
					<h5 class="text-danger text-center">{{graph.caption}}</h5>
					<nvd3-multi-bar-chart noData="No hay datos que mostrar" data="graph.data" showXAxis="true" showYAxis="true" showLegend="true" interactive="true" height="350" xAxisTickValues="xAxisTickValuesFunction()" xAxisTickFormat="xAxisTickFormatFunction()" rotateLabels="45" forcey="graph.forcey">
						<svg>
						</svg>
					</nvd3-multi-bar-chart>
				</div>
				<div ng-repeat="graph in graphs" ng-if="!graficasbarras &amp;&amp; graph.data &amp;&amp; graficasgrandes" style="clear:both" class="col-lg-12 well">
					<h5 class="text-danger text-center">{{graph.caption}}</h5>
					<nvd3-line-chart previous="nvd3-multi-bar-chart" noData="No hay datos que mostrar" data="graph.data" showXAxis="true" showYAxis="true" showLegend="true" interactive="true" height="350" xAxisTickValues="xAxisTickValuesFunction()" xAxisTickFormat="xAxisTickFormatFunction()" rotateLabels="45" forcey="graph.forcey">
						<svg>
						</svg>
					</nvd3-line-chart>
				</div>
				<div ng-repeat="graph in graphs" ng-if="graficasbarras &amp;&amp; graph.data &amp;&amp; graficasgrandes" style="clear:both" class="col-lg-12 well">
					<h5 class="text-danger text-center">{{graph.caption}}</h5>
					<nvd3-multi-bar-chart previous="nvd3-multi-bar-chart" noData="No hay datos que mostrar" data="graph.data" showXAxis="true" showYAxis="true" showLegend="true" interactive="true" height="350" xAxisTickValues="xAxisTickValuesFunction()" xAxisTickFormat="xAxisTickFormatFunction()" rotateLabels="45" forcey="graph.forcey">
						<svg>
						</svg>
					</nvd3-multi-bar-chart>
				</div>
			</div>
			<hr/>
			<h5 class="text-danger">Incidencias</h5>
			<div class="table-resposive">
				<table class="table table-striped table-bordered">
					<thead>
						<tr>
							<th></th>
							<th ng-repeat="mes in meses">{{mes}}</th>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="(incidencia,valores) in procedimientoSeleccionado.periodos[anualidad].incidencias"> 
							<th>{{incidencia}}</th>
							<td ng-repeat="val in valores track by $index" ng-class="{'text-danger': val }" class="numberCell">{{val}}</td>
						</tr>
					</tbody>
				</table>
			</div>

			<hr/>
			<h5 class="text-danger" ng-If="inconsistencias.length>0">Inconsistencias</h5>
			<p ng-If="inconsistencias.length>0">Una inconsistencia se da cuando alguno de los datos introducidos no refleja valores coherentes con el resto. Así, por ejemplo, no es consistente que haya un número negativo de expedientes resueltos, ni que el número de expedientes resueltos sea superior al de expedientes solicitados.</p>
			<div ng-repeat="inconsistencia in inconsistencias" role="alert" ng-if="inconsistencia.datos.length > 0" class="alert alert-warning">
				<span>{{inconsistencia.titulo}}</span>
			</div>

		</div>
	</div>
</div>
<hr class="clear"/>